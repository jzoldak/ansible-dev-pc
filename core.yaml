- name: Core OS packages
  hosts: 127.0.0.1
  connection: local

  tasks:
    - name: Enable HTTPS APT support
      become: true
      apt:
        name: "{{ packages }}"
      vars:
        packages:
          - apt-transport-https
          - ca-certificates
          - software-properties-common
          - gnupg

    - name: Update APT package list
      become: true
      apt:
        update_cache: true
      register: apt_update
      retries: 5
      until: apt_update is success

    - name: Upgrade to latest APT packages
      become: true
      apt:
        upgrade: yes

    - name: Install core packages
      become: true
      apt:
        package:
          - curl
          - dconf-editor
          - exfat-fuse
          - htop
          - inetutils-traceroute
          - jq
          - libcurl4-openssl-dev
          - libssl-dev
          - net-tools
          - ripgrep
          - snapd
          - uuid
          - xclip

    - name: Create ~/bin
      file:
        path: ~/bin
        state: directory

    - name: Add ~/bin to PATH
      lineinfile:
        path: ~/.bashrc
        line: export PATH=$PATH:~/bin

    - name: Add /snap/bin to PATH
      lineinfile:
        path: ~/.bashrc
        line: export PATH=$PATH:/snap/bin

    - name: Get installed package list
      package_facts: {}

    - name: Add dm-crypt to /etc/initramfs-tools/modules
      become: true
      lineinfile:
        path: /etc/initramfs-tools/modules
        line: dm-crypt
      when: ansible_facts.packages["cryptsetup-initramfs"] is defined
