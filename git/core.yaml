- name: git
  hosts: 127.0.0.1
  connection: local

  vars:
    - RIPGREP_VERSION: "11.0.2"

  tasks:
    - name: Add Git APT package repository (Ubuntu)
      become: true
      apt_repository:
        repo: ppa:git-core/ppa
        filename: git
        update_cache: no
      register: apt_repository_1
      when: ansible_distribution == 'Ubuntu'

    - name: Add Backports repository (Debian Stretch)
      become: true
      apt_repository:
        repo: deb http://deb.debian.org/debian stretch-backports main
        filename: backports
        update_cache: no
      register: apt_repository_2
      when: ansible_distribution_release == 'stretch'

    - name: Update APT package list
      become: true
      apt:
        update_cache: true
      when: apt_repository_1.changed or apt_repository_2.changed
      register: apt_update
      retries: 5
      until: apt_update is success

    - name: Install APT packages
      become: true
      apt:
        package:
          - git
          - git-gui
          - git-lfs
          - gitk
        state: latest

    - name: Set up git alias for branch
      git_config:
        name: alias.br
        scope: global
        value: branch

    - name: Set up git alias for checkout
      git_config:
        name: alias.co
        scope: global
        value: checkout

    - name: Use vi for git editor
      git_config:
        name: core.editor
        scope: global
        value: vi

    - name: Do not rebase on git pull by default
      git_config:
        name: pull.rebase
        scope: global
        value: false

    - name: Set git user.email
      git_config:
        name: user.email
        scope: global
        value: jesse.zoldak@clearballot.com

    - name: Set git user.name
      git_config:
        name: user.name
        scope: global
        value: Jesse Zoldak

    - name: Set default branch to main
      git_config:
        name: init.defaultBranch
        scope: global
        value: main
